<link rel="import" href="../polymer/polymer.html">
<script src="../autobahnjs/autobahn.min.js"></script>
<!--
`autobahn-connection`


@demo demo/index.html
-->

<dom-module id="autobahn-connection">
    <template>
    </template>
    <script>
        Polymer({
            is: 'autobahn-connection',
            properties: {
                authid: {
                    type: String,
                    reflectToAttribute: true,
                    notify: true
                },
                session: Object,
                connection: {
                    type: Object,
                    reflectToAttribute: true,
                    notify: true
                },
                methods: {
                    type: Object,
                    reflectToAttribute: true,
                    value: function() { return ['cookie', 'wampcra']; }
                },
                realm: {
                    type: String,
                    reflectToAttribute: true,
                    value: function() { return 'realm1'; }
                },
                disable_url: {
                  type: String,
                  value: _ => ""
                },
                url: {
                    type: String,
                    reflectToAttribute: true
                },
                endpointSuffix: {
                    type: String,
                    reflectToAttribute: true,
                    value: function() { return '';}
                },
                protocolPrefix: {
                    type: String,
                    reflectToAttribute: true,
                    value: function() { return 'wss';}
                },
                callables: Array
            },
            listeners: {

            },

            created: function() {

            },

            attached: function() {
            },

            _onOpen: function(session, details) {
                this.authid = details.authid;
                this.fire('autobahn-auth-accepted', {session: session, details: details});
            },

            call(endpoint, args) {
              return this.connection.session.call(endpoint, args)
            },

            subscribe(topic, func) {
              return this.connection.session.subscribe(topic, func)
            },

            publish(topic, args) {
              return this.connection.session.publish(topic, args)
            },

            register(endpoint, func) {
              return this.connection.session.publish(endpoint, func)
            },

            _onClose: function(reason, details) {
                console.log("disconnected", reason, details.reason, details);
                if(details.reason === "wamp.error.authentication_failed") {
                    this.fire('autobahn-auth-denied', {details: details});
                }
                if(reason === "unreachable") {
                    this.fire('autobahn-auth-unreachable', {details: details});
                }
            },

            connect: function(user, pass) {

                // if no provided URL, or serving via localhost
                if(this.url === undefined || window.location.host == 'localhost:8081') {
                    this.url = "localhost:8080"
                }

                function challenge(session, method, extra) {
                    console.log("onchallenge", method, extra);
                    console.log(extra);
                    if (method == 'wampcra') {
                        console.log(pass);
                        return autobahn.auth_cra.sign(pass, extra.challenge);
                    }
                };

                var connection_config = {
                  url: `${this.protocolPrefix}://${this.url}/${this.endpointSuffix}`,
                  realm: this.realm
                };
                if(this.methods.indexOf("wampcra") != -1) {
                  connection_config.authmethods = this.methods;
                  connection_config.authid = user;
                  connection_config.onchallenge = challenge;
                }
                console.log(connection_config);
                this.connection = new autobahn.Connection(connection_config);
                this.connection.onclose = this._onClose.bind(this);
                this.connection.onopen = this._onOpen.bind(this);
                this.connection.open();
            }

        })
    </script>
</dom-module>
